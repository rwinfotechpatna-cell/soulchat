<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SoulConnect - Global & Private Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@200;300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        :root {
            --bg-deep: #050203;
            --rose-gold: #e2b4bd;
            --text-white: #fff5f6;
            --glass: rgba(255, 255, 255, 0.05);
            --accent: #ff4d6d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            width: 100%; height: 100%; overflow: hidden; 
            background-color: var(--bg-deep); font-family: 'Montserrat', sans-serif; 
            color: var(--text-white); position: fixed; 
        }

        /* --- Premium Setup UI --- */
        #setup-ui { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 3000; background: radial-gradient(circle at center, #1a0a0d 0%, #050203 100%); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            padding: 20px;
        }
        
        .setup-container { width: 100%; max-width: 420px; text-align: center; position: relative; }

        .logo-area { margin-bottom: 40px; animation: fadeInDown 1s ease; }
        .logo-area h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(to bottom, var(--rose-gold), #8a6a71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .input-card { 
            background: rgba(255, 255, 255, 0.03); 
            padding: 40px 30px; 
            border-radius: 24px; 
            border: 1px solid rgba(226, 180, 189, 0.15); 
            backdrop-filter: blur(25px); 
            animation: fadeInUp 1.2s ease;
        }

        input#user-name { 
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(226, 180, 189, 0.2); 
            color: white; padding: 18px; border-radius: 15px; margin-bottom: 25px; 
            outline: none; text-align: center; font-size: 1.1rem;
        }

        .start-btn { 
            width: 100%; background: var(--rose-gold); color: #050203; border: none; 
            padding: 18px; border-radius: 15px; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: 0.3s;
        }

        /* --- Chat Styles --- */
        #chat-display { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .cinematic-box { position: absolute; text-align: center; width: 90%; animation: cinematicIn 8s forwards; pointer-events: auto; cursor: pointer; }
        
        @keyframes cinematicIn {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); filter: blur(10px); }
            10% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
            90% { opacity: 1; transform: scale(1.02); filter: blur(0); }
            100% { opacity: 0; transform: scale(1.1) translateY(-30px); filter: blur(15px); }
        }

        #sidebar { position: fixed; top: 20px; right: 20px; z-index: 150; width: 150px; display: none; flex-direction: column; }
        .user-item { padding: 10px; margin-bottom: 8px; border-radius: 20px; font-size: 0.8rem; background: var(--glass); display: flex; align-items: center; gap: 10px; cursor: pointer; border: 1px solid transparent; }
        .user-item:hover { border-color: var(--rose-gold); }

        #private-chat { position: fixed; bottom: 90px; right: 20px; width: 300px; height: 400px; background: rgba(10,10,10,0.98); border-radius: 20px; border: 1px solid var(--rose-gold); z-index: 500; display: none; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,1); }
        #pc-header { padding: 15px; border-bottom: 1px solid rgba(226,180,189,0.2); display: flex; justify-content: space-between; }
        #pc-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .pm { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 0.85rem; }
        .pm.sent { align-self: flex-end; background: var(--rose-gold); color: black; }
        .pm.rec { align-self: flex-start; background: var(--glass); }

        #input-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; z-index: 100; display: none; background: rgba(20,20,20,0.9); padding: 6px; border-radius: 50px; border: 1px solid rgba(226,180,189,0.3); backdrop-filter: blur(10px); }
        #msg-input { flex: 1; background: transparent; border: none; color: white; padding: 10px 15px; outline: none; }
        
        #notif { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 10px 25px; border-radius: 50px; z-index: 2000; display: none; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="notif">नया मैसेज!</div>

    <div id="setup-ui">
        <div class="setup-container">
            <div class="logo-area">
                <h1>SoulConnect</h1>
                <p style="letter-spacing: 4px; color: var(--rose-gold); font-size: 0.7rem;">LIVE CINEMATIC CHAT</p>
            </div>
            <div class="input-card">
                <input type="text" id="user-name" placeholder="आपका प्यारा नाम..." autocomplete="off">
                <button class="start-btn" id="start-btn" onclick="joinChat()">चैट शुरू करें</button>
            </div>
            <p id="status-text" style="margin-top:20px; font-size:0.7rem; color:gray;"></p>
        </div>
    </div>

    <div id="sidebar"><div id="online-list"></div></div>

    <div id="private-chat">
        <div id="pc-header">
            <span id="pc-target-name" style="font-weight:700;">User</span>
            <button onclick="closePrivateChat()" style="background:none; border:none; color:white; cursor:pointer">✕</button>
        </div>
        <div id="pc-messages"></div>
        <div style="padding:10px; display:flex; gap:5px; border-top:1px solid #333;">
            <input type="text" id="pc-input" placeholder="मैसेज..." style="flex:1; background:none; border:none; color:white; outline:none;">
            <button onclick="sendPrivateMessage()" style="background:var(--rose-gold); border:none; padding:5px 10px; border-radius:10px; cursor:pointer">भेजें</button>
        </div>
    </div>

    <div id="chat-display"></div>

    <div id="input-bar">
        <input type="text" id="msg-input" placeholder="दुनिया को कुछ कहें..." maxlength="70">
        <button onclick="sendMessage()" style="background:var(--rose-gold); border:none; padding:10px 20px; border-radius:30px; font-weight:700; cursor:pointer">भेजें</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAX4TWE46VMW0l6QzfAgPFqluvXhbOxzUo",
            authDomain: "mycinematicchat.firebaseapp.com",
            projectId: "mycinematicchat",
            storageBucket: "mycinematicchat.firebasestorage.app",
            messagingSenderId: "982781079010",
            appId: "1:982781079010:web:4a68ac4a70e81655599dbb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // App ID is very important. Ensure this matches your Firestore Rules
        const appId = "global-cinematic-prod-v2";

        let currentUser = null;
        let myName = "";
        let activePrivateUser = null;

        const setStatus = (msg) => {
            document.getElementById('status-text').innerText = msg;
        };

        window.joinChat = async () => {
            myName = document.getElementById('user-name').value.trim();
            if(!myName) return;
            
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerText = "Connecting...";
            setStatus("Firebase से जुड़ रहे हैं...");

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error(error);
                setStatus("Error: " + error.message);
                btn.disabled = false;
                btn.innerText = "चैट शुरू करें";
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user && myName) {
                currentUser = user;
                setStatus("ऑनलाइन आ रहे हैं...");

                document.getElementById('setup-ui').style.display = 'none';
                document.getElementById('input-bar').style.display = 'flex';
                document.getElementById('sidebar').style.display = 'flex';

                try {
                    // Update Online Status
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'online_users', user.uid), {
                        name: myName, uid: user.uid, lastSeen: serverTimestamp()
                    }, { merge: true });

                    // 1. Listen for Online Users
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'online_users'), (snap) => {
                        const list = document.getElementById('online-list');
                        list.innerHTML = '';
                        snap.forEach(d => {
                            const u = d.data();
                            if(u.uid !== currentUser.uid) {
                                const div = document.createElement('div');
                                div.className = 'user-item';
                                div.innerHTML = `<span style="color:#4ade80">●</span> ${u.name}`;
                                div.onclick = () => openPrivateChat(u.uid, u.name);
                                list.appendChild(div);
                            }
                        });
                    }, (err) => console.error("Online list error:", err));

                    // 2. Listen for Global Messages
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (snap) => {
                        snap.docChanges().forEach(change => {
                            if (change.type === "added") {
                                const data = change.doc.data();
                                if(data.senderUid !== currentUser.uid) showCinematic(data);
                            }
                        });
                    }, (err) => console.error("Global msg error:", err));

                    // 3. Listen for Private Messages
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'private_messages'), (snap) => {
                        snap.docChanges().forEach(change => {
                            if (change.type === "added") {
                                const data = change.doc.data();
                                if(data.to === currentUser.uid) {
                                    if(!activePrivateUser || activePrivateUser.uid !== data.from) {
                                        showNotification(`नया संदेश: ${data.senderName}`);
                                    }
                                    if(activePrivateUser && activePrivateUser.uid === data.from) {
                                        appendPrivateMessage(data.text, 'rec');
                                    }
                                }
                            }
                        });
                    }, (err) => console.error("Private msg error:", err));

                } catch (e) {
                    console.error("Firestore Error:", e);
                    alert("Firestore Access Denied. Please check Rules.");
                }
            }
        });

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !currentUser) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text, sender: myName, senderUid: currentUser.uid, createdAt: serverTimestamp()
                });
                showCinematic({ text, sender: 'Me', senderUid: currentUser.uid });
                input.value = '';
            } catch(e) {
                alert("मैसेज नहीं जा सका: " + e.message);
            }
        };

        window.openPrivateChat = (uid, name) => {
            activePrivateUser = { uid, name };
            document.getElementById('pc-target-name').innerText = name;
            document.getElementById('private-chat').style.display = 'flex';
            document.getElementById('pc-messages').innerHTML = '';
        };

        window.closePrivateChat = () => {
            activePrivateUser = null;
            document.getElementById('private-chat').style.display = 'none';
        };

        window.sendPrivateMessage = async () => {
            const input = document.getElementById('pc-input');
            const text = input.value.trim();
            if(!text || !activePrivateUser || !currentUser) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'private_messages'), {
                    text, from: currentUser.uid, to: activePrivateUser.uid,
                    senderName: myName, createdAt: serverTimestamp()
                });
                appendPrivateMessage(text, 'sent');
                input.value = '';
            } catch(e) {
                alert("प्राइवेट मैसेज एरर: " + e.message);
            }
        };

        function appendPrivateMessage(text, type) {
            const container = document.getElementById('pc-messages');
            const div = document.createElement('div');
            div.className = `pm ${type}`;
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showCinematic(data) {
            const display = document.getElementById('chat-display');
            const box = document.createElement('div');
            box.className = 'cinematic-box';
            box.style.left = (Math.random() * 5) + "%";
            box.style.top = (25 + Math.random() * 35) + "%";
            box.innerHTML = `
                <div style="font-size:0.6rem; color:var(--rose-gold); text-transform:uppercase">${data.sender}</div>
                <div style="font-family:'Playfair Display'; font-size:1.8rem; font-style:italic">"${data.text}"</div>
            `;
            box.onclick = () => { if(data.senderUid !== currentUser.uid) openPrivateChat(data.senderUid, data.sender); };
            display.appendChild(box);
            setTimeout(() => box.remove(), 8000);
        }

        function showNotification(msg) {
            const n = document.getElementById('notif');
            n.innerText = msg;
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 4000);
        }
    </script>
</body>
</html>
